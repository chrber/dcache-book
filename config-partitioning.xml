<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
                         "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
<!ENTITY % sharedents SYSTEM "shared-entities.xml" >
%sharedents;
]>

<!-- TODO move to chapter PoolManager -->

<chapter id="cf-partitioning">

  <title>&dcache; Partitioning</title>

  <para>
    There are various parameters in the &dcache; &cell-poolmngr;
    subsystem, determining the system behaviour on particular
    events. These are for example the cost threshold at which the
    &cell-poolmngr; initiates pool to pool transfers to smooth the
    overall system load, or the balance between performance and disk
    space related costs to optimize request distribution among data
    pools. A defined set of parameters can have different values for
    different partitions of the complete &dcache; instance.  &dcache;
    provides a web page, listing partitions, assigned parameters and
    inheritance information.
  </para>


  <section id="cf-paritioning-sections">
    <title>Parameters, partitions and inheritance</title>

    <para>
      Parameters, currently part of the partitioning scheme, are
      listed within the next paragraph, together with a way of
      assigning values. Each of those parameters may be set to
      different values for different, so called &dcache;
      <firstterm>partitions</firstterm>.
    </para>

    <para>
      The only partition,
      existing without being created, is the default
      partition. All partitions can be
      created or modified. If only a subset of parameters of a
      non default partition is defined, the
      residual parameters of this partition are
      inherited from the default partition. So,
      changing a parameter in the default
      partition, will change the same parameter of all other
      partitions for which this particular
      parameter has not been overwritten.
    </para>

    <para>
      Commands related to &dcache; partitioning :
    </para>

    <itemizedlist>
      <listitem>
	<para>
	  <cmdsynopsis>
	    <command>pm create</command>
	    <arg><replaceable>partitionName</replaceable></arg>
	  </cmdsynopsis>
	  creates a new partition.
	</para>
      </listitem>

      <listitem>
	<para>
	  <cmdsynopsis>
	    <command>pm set</command>
	    <arg><replaceable>partitionName</replaceable></arg>
	    <arg choice='plain'> -<replaceable>parameterName</replaceable></arg>
	    <arg>=<replaceable>value</replaceable>|off</arg>
	  </cmdsynopsis>
	  sets a parameter <replaceable>parameterName</replaceable> to
	  a new value. If <replaceable>partitionName</replaceable> is
	  omitted, the <literal>default</literal> partition is used.
	</para>

	<para>
	  If <replaceable>partitionName</replaceable> doesn't exist
	  yet, it is (silently) created.
	</para>
	<warning>
	  This can cause problems: If you want to set a value for a
	  partition and misspell the partition name a new partition
	  will be created. Therefore this feature will be removed.
	</warning>
	<para>
	  If a parameter is set to <literal>off</literal> this
	  parameter is no longer overwritten and is inherited from the
	  <literal>default</literal> partition.  Setting a value to
	  <literal>off</literal> for the <literal>default</literal>
	  partition does not have any effect.
	</para>
      </listitem>

      <listitem>
	<para>
	  <cmdsynopsis>
	    <command>pm ls</command>
	    <arg>-l</arg>
	    <arg><replaceable>partitionName</replaceable></arg>
	  </cmdsynopsis>
	  lists a single or all partitions.  Except for the
	  <literal>default</literal>, only those parameters are shown
	  which are explicitly set. Parameters, not shown, are
	  inherited from the <literal>default</literal> partition.
	</para>
      </listitem>

      <listitem>
	<para>
	  <cmdsynopsis>
	    <command>pm destroy</command>
	    <arg choice='plain'><replaceable>partitionName</replaceable></arg>
	  </cmdsynopsis>
	  completely removes a partition from &dcache;.
	</para>
      </listitem>
    </itemizedlist>

    <para>
      In the <link linkend="intouch-web">Web Interface</link> you can
      find a web page listing partitions and more information.  You
      will find a page summarizing the partition status of the
      system. This is essentially the output of the command
      <command>pm ls -l</command>.
    </para>

    <informalexample>
      <para>
	For your &dcache; on <systemitem
	class='domainname'>example.org</systemitem> the address is
      </para>
      <para>
	<uri>http://dcache.example.org:2288/poolInfo/parameterHandler/set/matrix/*</uri>
      </para>
    </informalexample>

  </section>

  <section id="cf-partitioning-parameters">
    <title>Partition Parameters</title>

    <para>
      The following list describes which parameters may be used in
      conjunction with &dcache; partitioning.
    </para>

    <para>
      Recall that the <link linkend='cf-pm-cm-total'>total cost</link>
      of a pool is a linear combination of the <glossterm
      linkend="gl-performance_cost">performance</glossterm> and
      <glossterm linkend="gl-space_cost">space cost</glossterm>. It is
      calculated by
    </para>
    <informalequation>
      <mathphrase>totalCost = ccf * perfCost + scf * spaceCost</mathphrase>
    </informalequation>
    <para>
      where the <literal>cpu cost factor</literal>
      <varname>ccf</varname> and the <literal>space cost
      factor</literal> <varname>scf</varname> are configurable with
      the command <command>pm set</command>.
    </para>
    <blockquote>
      <cmdsynopsis>
	<command>pm set</command>
	<arg choice='plain'>-spacecostfactor=<replaceable>value</replaceable></arg>
	<arg choice='plain'>-cpucostfactor=<replaceable>value</replaceable></arg>
      </cmdsynopsis>
    </blockquote>

    <note>
      <para>
	Using the command <command>pm set</command> without specifying
	a partition leads to changes in the default partition.
      </para>
    </note>

    <para>
      To set these and more values see the table below.
    </para>

    <para>
      <replaceable>value</replaceable> = <literal>0.0</literal> implies that the feature is disabled.
    </para>
    <para>
      <replaceable>value</replaceable> = <literal>off</literal>
      implies that the value is inherited from the default section.
    </para>

    <informaltable>
      <tgroup cols="3" align="left">
	<colspec colnum="1"  colwidth="13em"/>
	<colspec colnum="2"  colwidth="*"/>
	<colspec colnum="3"  colwidth="4em"/>
	<thead>
	  <row>
	    <entry>Command</entry>
	    <entry>Meaning</entry>
	    <entry>Type</entry>
	  </row>
	</thead>

	<tbody>

	  <row>
	    <entry>
	      <cmdsynopsis>
	      <command>pm set</command>
	      <arg><replaceable>partitionName</replaceable></arg>
	      <arg choice='plain'>-spacecostfactor=<replaceable>scf</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the <literal>space cost factor</literal> for the partition.
	      </para>
	      <para>
		The default value is <literal>1.0</literal>.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-cpucostfactor=<replaceable>ccf</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the cpu cost factor for the partition.
	      </para>
	      <para>
		The default value is <literal>1.0</literal>.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-idle=<replaceable>idle-value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		The concept of the <firstterm>idle value</firstterm>
		will be turned on if
		<replaceable>idle-value</replaceable> &gt;
		<literal>0.0</literal>.
	      </para>
	      <para>
		A pool is idle if its performance cost is smaller than
		the <replaceable>idle-value</replaceable>. Otherwise
		it is not idle.
	      </para>
	      <para>
		If one or more pools that satisfy the read request are
		idle then only one of them is chosen for a particular
		file irrespective of total cost. I.e. if the same file
		is requested more than once it will always be taken
		from the same pool. This allowes the copies on the
		other pools to age and be garbage collected.
	      </para>
	      <para>
		The default value is <literal>0.0</literal>, which
		disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-p2p=<replaceable>p2p-value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the static replication threshold for the
		partition.
	      </para>
	      <para>
		If the performance cost on the best pool exceeds
		<replaceable>p2p-value</replaceable> and the value for
		<link
		linkend='slope'><replaceable>slope</replaceable></link>
		= <literal>0.0</literal> then this pool is called
		<firstterm>hot</firstterm> and a pool to pool
		replication may be triggered.
	      </para>
	      <para>
		The default value is <literal>0.0</literal>, which
		disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-alert=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the <firstterm>alert value</firstterm> for the
		partition.
	      </para>
	      <para>
		If the best pool's performance cost exceeds the p2p
		value and the alert value then no pool to pool copy is
		triggered and a message will be logged stating that no
		pool to pool copy will be made.
	      </para>
	      <para>
		The default value is <literal>0.0</literal>, which
		disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-panic=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the <firstterm>panic cost cut level</firstterm>
		for the partition.
	      </para>
	      <para>
		If the performance cost of the best pool exceeds the
		panic cost cut level the request will fail.
	      </para>
	      <para>
		The default value is <literal>0.0</literal>, which
		disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-fallback=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the fallback cost cut level for the partition.
	      </para>
	      <para>
		If the best pool's performance cost exceeds the
		fallback cost cut level then a pool of the next
		<firstterm>level</firstterm> will be chosen. This
		means for example that instead of choosing a pool with
		<literal>readpref</literal> = 20 a pool with
		<literal>readpref</literal> &lt; 20 will be chosen.
	      </para>
	      <para>
		The default value is <literal>0.0</literal>, which disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry id='slope'>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-slope=<replaceable>slope</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the dynamic replication threshold value for the
		partition.
	      </para>
	      <para>
		If <replaceable>slope</replaceable>&gt;
		<literal>0.01</literal> then the product of best
		pool's performance cost and
		<replaceable>slope</replaceable> is used as threshold
		for pool to pool replication.
	      </para>
	      <para>
		If the performance cost on the best pool exceeds this
		threshold then this pool is called hot.
	      </para>

	      <para>
		The default value is <literal>0.0</literal>, which disables this feature.
	      </para>
	    </entry>
	    <entry>
	      float
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-p2p-allowed=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		This value can be specified if an &hsm; is attached to
		the &dcache;.
	      </para>
	      <para>
		If a partition has no &hsm; connected, then this
		option is overridden. This means that no matter which
		value is set for <literal>p2p-allowed</literal> the
		pool to pool replication will always be allowed.
	      </para>
	      <para>
		By setting <replaceable>value</replaceable> =
		<literal>off</literal> the values for
		<literal>p2p-allowed</literal>,
		<literal>p2p-oncost</literal> and
		<literal>p2p-fortransfer</literal> will take over the
		value of the default partition.
	      </para>
	      <para>
		If <replaceable>value</replaceable> =
		<literal>yes</literal> then pool to pool replication
		is allowed.
	      </para>
	      <para>
		As a side effect of setting <replaceable>value</replaceable> =
		<literal>no</literal> the values for
		<literal>p2p-oncost</literal> and
		<literal>p2p-fortransfer</literal> will also be set to
		<literal>no</literal>.
	      </para>
	      <para>
		The default value is <literal>yes</literal>.
	      </para>
	    </entry>
	    <entry>
	      boolean
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-p2p-oncost=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Determines whether pool to pool replication is allowed
		if the best pool for a read request is hot.
	      </para>
	      <para>
		The default value is <literal>no</literal>.
	      </para>
	    </entry>
	    <entry>
	      boolean
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-p2p-fortransfer=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		If the best pool is hot and the requested file will be
		copied either from the hot pool or from tape to
		another pool, then the requested file will be read
		from the pool where it just had been copied to if
		<replaceable>value</replaceable> = <literal>yes</literal>.
		If
		<replaceable>value</replaceable> = <literal>no</literal>
		then the requested file will be read from the hot
		pool.
	      </para>
	      <para>
		The default value is <literal>no</literal>.
	      </para>
	    </entry>
	    <entry>
	      boolean
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-stage-allowed=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Set the <firstterm>stage allowed value</firstterm> to
		<literal>yes</literal> if a tape system is connected
		and to <literal>no</literal> otherwise.
	      </para>
	      <para>
		As a side effect, setting the value for
		<literal>stage-allowed</literal> to
		<literal>no</literal> changes the value for
		<literal>stage-oncost</literal> to
		<literal>no</literal>.
	      </para>
	      <para>
		The default value is <literal>no</literal>.
	      </para>
	    </entry>
	    <entry>
	      boolean
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-stage-oncost=<replaceable>value</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		If the best pool is hot, p2p-oncost is disabled and an
		&hsm; is connected to a pool then this parameter
		determines whether to stage the requested file to a
		different pool.
	      </para>
	      <para>
		The default value is <literal>no</literal>.
	      </para>
	    </entry>
	    <entry>
	      boolean
	    </entry>
	  </row>

	  <row>
	    <entry>
	      <cmdsynopsis>
		<command>pm set</command>
		<arg><replaceable>partitionName</replaceable></arg>
		<arg choice='plain'>-max-copies=<replaceable>copies</replaceable></arg>
	      </cmdsynopsis>
	    </entry>
	    <entry>
	      <para>
		Sets the maximal number of replicas of one file. If the maximum is
		reached no more replicas will be created.
	      </para>
	      <para>
		The default value is <literal>500</literal>.
	      </para>
	    </entry>
	    <entry>
	      integer
	    </entry>
	  </row>

	</tbody>
      </tgroup>
    </informaltable>

  </section>

  <section id="cf-partitioning-links">
    <title>Partitions and Links</title>
    <para>
      A partition, so far, is just a set of
      parameters which may or may not differ from the default set. To
      let a partition relate to a part of the
      &dcache;, links are used.  Each link may be assigned to exactly
      one partition. If not set, or the assigned
      partition doesn't exist, the link defaults to
      the <literal>default</literal> partition.
    </para>

    <cmdsynopsis>
      <command>psu set link</command>
      <arg><replaceable>linkName</replaceable></arg>
      <arg choice='plain'>-section=<replaceable>partitionName</replaceable></arg>
      <arg rep='repeat' choice='opt'><replaceable>other-options</replaceable></arg>
    </cmdsynopsis>

    <para>
      Whenever this link is chosen for pool selection, the associated
      parameters of the assigned partition will
      become active for further processing.
    </para>

    <warning>
      <para>
	Depending on the way links are setup it may very well happen
	that more than just one link is triggered for a particular
	&dcache; request. This is not illegal but leads to an
	ambiguity in selecting an appropriate &dcache;
	partition. If only one of the selected
	links has a partition assigned, this
	partition is chosen.  Otherwise, if
	different links point to different
	partitions, the result is indeterminate.
	This issue is not yet solved and we recommend to clean up the
	&serv-poolmngr; configuration to eliminate links with the same
	preferences for the same type of requests.
      </para>
    </warning>
  </section>

  <section id="cf-partitioning-examples">
    <title>Examples</title>
    <para>
      For the subsequent examples we assume a basic &serv-poolmngr;
      setup :
    </para>

    <informalexample>
      <programlisting>#
# define the units
#
psu create -protocol   */*
psu create -protocol   xrootd/*
psu create -net        0.0.0.0/0.0.0.0
psu create -net        131.169.0.0/255.255.0.0
psu create -store      *@*
#
#  define unit groups
#
psu create ugroup  any-protocol
psu create ugroup  any-store
psu create ugroup  world-net
psu create ugroup  xrootd
#
psu addto ugroup any-protocol */*
psu addto ugroup any-store    *@*
psu addto ugroup world-net    0.0.0.0/0.0.0.0
psu addto ugroup desy-net     131.169.0.0/255.255.0.0
psu addto ugroup xrootd       xrootd/*
#
#  define the pools
#
psu create pool pool1
psu create pool pool2
#
#  define the pool groups
#
psu create pgroup default-pools
psu create pgroup special-pools
#
psu addto pgroup default-pools pool1
psu addto pgroup default-pools pool2
#
psu addto pgroup special-pools pool1
psu addto pgroup special-pools pool2
#</programlisting>
    </informalexample>

    <section>
      <title>Disallowing pool to pool transfers for special pool
      groups based on the access protocol</title>

      <para>
	For a special set of pools, where we only allow the &xrootd;
	protocol, we don't want the datasets to be replicated on high
	load while for the rest of the pools we allow replication on
	hot spot detection.
      </para>
      <informalexample>
	<programlisting>#
#
pm set default        -p2p=0.4
pm set xrootd-section -p2p=0.0
#
psu create link default-link any-protocol any-store world-net
psu add    link default-link default-pools
psu set    link default-link -readpref=10 -cachepref=10 -writepref=0
#
psu create link xrootd-link xrootd any-store world-net
psu add    link xrootd-link special-pools
psu set    link xrootd-link -readpref=11 -cachepref=11 -writepref=0
psu set    link xrootd-link -section=xrootd-section
#        </programlisting>
      </informalexample>
    </section>

    <section>
      <title>Choosing pools randomly for incoming traffic only</title>

      <para>
	For a set of pools we select pools following the default
	setting of cpu and space related cost factors. For incoming
	traffic from outside, though, we select the same pools, but in
	a randomly distributed fashion.  Please
	note that this is not really a physical partitioning of the
	&dcache; system, but rather a virtual one, applied to the same
	set of pools.
      </para>
      <informalexample>
	<programlisting>#
#
pm set default          -cpucostfactor=0.2 -spacecostfactor=1.0
pm set incoming-section -cpucostfactor=0.0 -spacecostfactor=0.0
#
psu create link default-link any-protocol any-store desy-net
psu add    link default-link default-pools
psu set    link default-link -readpref=10 -cachepref=10 -writepref=10
#
psu create link default-link any-protocol any-store world-net
psu add    link default-link default-pools
psu set    link default-link -readpref=10 -cachepref=10 -writepref=0
#
psu create link incoming-link any-protocol any-store world-net
psu add    link incoming-link default-pools
psu set    link incoming-link -readpref=10 -cachepref=10 -writepref=10
psu set    link incoming-link -section=incoming-section
#</programlisting>
      </informalexample>
    </section>

  </section>

</chapter>
